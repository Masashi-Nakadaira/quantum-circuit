# Quantum Circuit Simulator コード理解メモ & 改善提案

## 1. 現状の構造理解

### 全体アーキテクチャ
- `ui/controls.js` の `App` クラスが実質的なオーケストレータになっており、
  - 回路モデル (`Circuit`)
  - 入力状態 (`InputState`)
  - シミュレータ (`QuantumEngine`)
  - 描画 (`CircuitCanvas`, `StateViewer`)
  - 学習 UI (`LearnDrawer`, `InputDrawer`)
  を束ねています。
- 描画・操作・計算がファイル分割されており、学習用の拡張 (`lessons/labs.js`) も分離されているため、機能追加はしやすい構成です。

### シミュレーション層
- 純粋状態は `sim/statevector.js`、混合状態は `sim/densitymatrix.js` で扱う二層構成になっており、教育用途として十分リッチです。
- `runShots` は最終状態からサンプリングするシンプル実装で、UXはわかりやすい一方、途中測定を厳密に反映しないケースがあります。

### データモデル層
- `model/circuit.js` に Gate/Circuit/InputState がまとまっており、JSONシリアライズ可能。
- 入力プリセットで「リンク（クラスタ）」概念を持っており、Bell/GHZ/W など教育向け初期状態を作れる設計がよいです。

---

## 2. 優先度つき改善案

## P0（先に着手推奨）

1. **イベント管理の集約（`controls.js` の肥大化対策）**
   - 課題: `App` が大きく、UIイベント・状態遷移・ドメイン処理が密結合。
   - 改善: `PlaybackController` / `PersistenceController` / `InputPresetController` などへ段階分割。
   - 効果: 不具合の局所化、テスト容易性向上、今後の機能追加（例: Undo/Redo）を安全に実装可能。

2. **測定仕様の明文化と実装の一致**
   - 課題: `runShots` のコメントにもある通り、途中測定ゲートの扱いが仕様として曖昧。
   - 改善: 「途中測定を反映するモード」と「終端一括測定モード」をUIで分離し、ヘルプ文言も統一。
   - 効果: 学習用途での誤解を減らし、アルゴリズム教材としての信頼性向上。

3. **テスト基盤の最小導入**
   - 課題: 回路シミュレーションの正しさを自動で担保する仕組みが見当たらない。
   - 改善: Node で動くユニットテスト（例: H|0>=|+>, Bell測定相関, Rx/Ry/Rz の既知ケース）を追加。
   - 効果: 数式ロジックのリグレッション防止、安心してリファクタ可能。

## P1（次点）

4. **永続化データのバージョン移行（migration）対応**
   - 課題: `version` は保存されるが、読み込み時のマイグレーション処理が未整備。
   - 改善: `loadCircuit` に `switch(version)` を置き、将来スキーマ差分を吸収。
   - 効果: 既存ユーザーデータ破損リスクを低減。

5. **定数定義の一元化**
   - 課題: 量子ビット最大数 (`5`) などが複数箇所に散在しやすい。
   - 改善: `config/constants.js` を作り、UI/Model/Simulator で共有。
   - 効果: 制約変更時の修正漏れ防止。

6. **表示文言の i18n 対応準備**
   - 課題: 日本語/英語文言が混在し、将来の多言語対応が難しい。
   - 改善: UI文言を辞書化（`locales/ja.js`, `locales/en.js`）。
   - 効果: UX統一、教材展開の柔軟性向上。

## P2（中長期）

7. **パフォーマンス最適化（TypedArray/バッファ再利用）**
   - 課題: 現実装は教育用途として十分だが、5量子ビット上限でも連続実行時 GC が増える可能性。
   - 改善: 複素数配列表現の最適化、演算バッファの再利用。
   - 効果: アニメーションと同時実行時の滑らかさ向上。

8. **アクセシビリティ改善**
   - 課題: 一部ボタンやドラッグ操作がキーボード利用前提でない。
   - 改善: ARIA 属性、フォーカス可視化、キーボードショートカット追加。
   - 効果: 教育現場での利用範囲拡大。

---

## 3. 直近2スプリントの実行案（例）

- **Sprint 1**
  1. シミュレータ単体テスト導入
  2. 測定モード仕様の明文化 + UI文言反映
  3. `controls.js` から永続化関連を分割

- **Sprint 2**
  1. 入力プリセット関連を分割
  2. LocalStorage migration 実装
  3. 定数一元化 + 軽いリファクタ

この順序だと、"正しさ担保 → 仕様明確化 → 保守性向上" の順で安全に改善できます。
