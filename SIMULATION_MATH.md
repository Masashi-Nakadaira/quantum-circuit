# シミュレーションの論理と計算

この文書では、量子回路シミュレータが状態の表現からゲートの適用、測定に至るまで、どのように計算を行っているかを説明します。

## 1. 状態の表現（状態ベクトル）

シミュレータは**状態ベクトル**表現を使用します。$n$個の量子ビットを持つシステムは、サイズ$2^n$の複素ベクトルによって記述されます。

$$|\psi\rangle = \sum_{i=0}^{2^n-1} c_i |i\rangle$$

- 各係数 $c_i$ は `[実部, 虚部]` として格納される複素数です。
- システムが基底状態 $|i\rangle$ で観測される確率は $|c_i|^2$ です。
- 全確率は1である必要があります：$\sum |c_i|^2 = 1$。

## 2. ゲートの適用

ゲートは、状態ベクトルを変換する**ユニタリ演算子**（行列）として扱われます：$|\psi_{next}\rangle = U |\psi_{prev}\rangle$。

### 1量子ビットゲート
量子ビット $k$ に作用するゲートは、$2 \times 2$ の行列 $M$ を使用します。シミュレータは、ビット $k$ のみが異なるすべての基底状態のペア $(|j_0\rangle, |j_1\rangle)$ を見つけ、それらの係数を更新します。

$$\begin{pmatrix} c_{j_0}' \\ c_{j_1}' \end{pmatrix} = \begin{pmatrix} M_{00} & M_{01} \\ M_{10} & M_{11} \end{pmatrix} \begin{pmatrix} c_{j_0} \\ c_{j_1} \end{pmatrix}$$

### 制御ゲート（CX, CZ）
制御ゲートは、制御量子ビットが $|1\rangle$ の場合にのみターゲット量子ビットに作用します。
- **CX (CNOT)**: 制御ビットが1である場所で、振幅 $c_{j_0}$ と $c_{j_1}$ を入れ替えます。
- **CZ**: 制御ビットが1である場所で、$c_{j_1}$ の符号を反転させます（すなわち $c_{j_1} \to -c_{j_1}$）。

### 回転ゲート（Rx, Ry, Rz）
これらのゲートは、角度 $\theta$ に基づいて特定の $2 \times 2$ 行列を計算します。
- **Rx($\theta$)**: $\begin{pmatrix} \cos(\theta/2) & -i\sin(\theta/2) \\ -i\sin(\theta/2) & \cos(\theta/2) \end{pmatrix}$
- **Ry($\theta$)**: $\begin{pmatrix} \cos(\theta/2) & -\sin(\theta/2) \\ \sin(\theta/2) & \cos(\theta/2) \end{pmatrix}$
- **Rz($\theta$)**: $\begin{pmatrix} e^{-i\theta/2} & 0 \\ 0 & e^{i\theta/2} \end{pmatrix}$

## 3. 測定

測定は、選択されたモードに応じて異なる動作をします。

### 確率モード (Probability Mode)
各ステップで状態ベクトルが計算され、確率分布 $|c_i|^2$ が表示されます。状態は**収縮（コラプス）しません**。これにより、波動関数の「純粋な」進化を確認できます。

### シングルショットモード (Single Shot Mode)
1. **サンプリング**: 確率分布に基づいて、1つの結果 $|x\rangle$ が選ばれます。
2. **射影（収縮）**: 量子ビット $k$ が測定され、結果が $v \in \{0, 1\}$ であった場合、状態ベクトルはビット $k$ が $v$ である部分空間に射影されます。ビット $k \neq v$ であるすべての係数は0になります。
3. **正規化**: 残ったベクトルは、全確率が1になるようにスケール調整されます。

### ショット実行 (Histogram)
シミュレータは**最終的な波動関数**を取得し、シード付き擬似乱数生成器（PRNG）を使用して $N$ 回（例：1024回）サンプリングを行い、結果のヒストグラムを生成します。

## 4. 実装の詳細
- **複素数演算**: `sim/complex.js` に独自の実装があります。
- **エンジン**: `sim/statevector.js` の `QuantumEngine` クラスが、列ごとのシミュレーションを制御します。
- **動的回路**: `model/circuit.js` の `SimulationStep` クラスが、アニメーション表示のために各ステップの状態を保持します。
